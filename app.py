from flask import Flask, render_template, request
import os
import time
import pyfiglet
import joblib
from Extract.PE_main import extract_infos
from utils import sanitization  # Import the 'sanitization' function


app = Flask(__name__)

# Replace with the actual paths to your trained models (if applicable)
pe_model_path = "./Classifier/classifier.pkl"
pe_features_path = "./Classifier/features.pkl"
url_model_path = "./Classifier/pickel_model.pkl"
url_vectorizer_path = "./Classifier/pickel_vector.pkl"

def run_pe_scan(file_path):
    # Load the trained model and features
    with open(pe_model_path, 'rb') as f:
        model = joblib.load(f)
    with open(pe_features_path, 'rb') as f:
        features = joblib.load(f)

    try:
        # Extract PE file features
        pe_data = extract_infos(file_path)
        pe_features = list(map(lambda x: pe_data[x], features))

        # Perform prediction
        prediction = model.predict([pe_features])[0]
        scan_result = "The file is predicted to be: " + ['malicious', 'legitimate'][prediction]

    except Exception as e:
        scan_result = "Error during PE file scanning: {}".format(str(e))

    return scan_result


def run_url_scan(url):
    # Load the trained model and vectorizer
    with open(url_model_path, 'rb') as f:
        model = joblib.load(f)
    with open(url_vectorizer_path, 'rb') as f:
        vectorizer = joblib.load(f)

    try:
        # Preprocess the URL
        processed_url = sanitization(url)  # Use the 'sanitization' function directly
        # Perform prediction
        prediction = model.predict(vectorizer.transform([processed_url]))[0]
        scan_result = "The URL is predicted to be: " + prediction

    except Exception as e:
        scan_result = "Error during URL scanning: {}".format(str(e))

    return scan_result


@app.route("/")
def home():
    return render_template("index.html")

@app.route("/scan", methods=["POST"])
def scan():
    scan_type = request.form.get("scan_type")
    file_path = request.form.get("file_path")
    url = request.form.get("url")

    if scan_type == "pe" and file_path:
        scan_result = run_pe_scan(file_path)
    elif scan_type == "url" and url:
        scan_result = run_url_scan(url)
    else:
        scan_result = "Invalid scan type or missing input."

    return render_template("scan_results.html", scan_result=scan_result)

if __name__ == "__main__":
    app.run(debug=True)
